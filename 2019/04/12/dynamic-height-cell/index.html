<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>TableView 动态 cell 高度自适应方案 | zltunes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><link rel="stylesheet" type="text/css" href="/css/code-number.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="/js/code-number.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">TableView 动态 cell 高度自适应方案</h1><a id="logo" href="/.">zltunes</a><p class="description">赵磊的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/resume/resume.pdf"><i class="fa fa-file"> 简历</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">TableView 动态 cell 高度自适应方案</h1><div class="post-meta">Apr 12, 2019<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span></div><div class="post-content"><p>相比安卓 ListView/RecylerView，iOS 中 TableViewCell 高度自适应是需要开发者自己想办法解决的，原因在于 tableview 的渲染机制默认是先获取 cell 高度，然后再去绘制 cell 体。由于 label/textview 等通常是高度不定的，cell 高度动态化是个很常见的需求。<br><a id="more"></a></p>
<h1 id="方案一：高度固定"><a href="#方案一：高度固定" class="headerlink" title="方案一：高度固定"></a>方案一：高度固定</h1><p>针对所有 Cell 具有固定高度的情况：</p>
<ol>
<li><code>self.tableView.rowHeight = 88;</code></li>
<li>实现协议方法 <code>heightForRowAtIndexPath:</code>。</li>
</ol>
<p><strong>缺点：</strong>不支持动态高度。</p>
<h1 id="方案二：cell-预估高度（iOS-7-）"><a href="#方案二：cell-预估高度（iOS-7-）" class="headerlink" title="方案二：cell 预估高度（iOS 7+）"></a>方案二：cell 预估高度（iOS 7+）</h1><p><strong>设计思路：</strong><br>加载 tableview 时一次性计算所有 cell 高度太耗性能。所以把计算 height 的任务从 load time 转移到 scrolling time。只有滑动到的 cell 会计算，屏幕外边的不会计算。<br>方法：<code>tableView: estimatedHeightForRowAtIndexPath:</code><br>这是 iOS 7.0 出现的 UITableViewDelegate 中的方法,表示返回某行 cell 的预估高度。这个方法改变了 TableView 代理方法的调用顺序。<br>未调用<code>estimatedHeightForRow...</code>方法时：<br><img src="/pic/005YhI8igy1fwa5hooy28j30f105z75c.jpeg" alt=""><br>调用<code>estimatedHeightForRow...</code>后：<br><img src="/pic/005YhI8igy1fwa5i5kg83j30fb03t0th.jpeg" alt=""><br>此时 tableView 工作原理：</p>
<ol>
<li>tableView 先向代理拿得到每个 cell 的预估高度(<code>estimatedHeightForRow...</code>方法)，并且拿这个高度去计算整个 tableView 应该显示的范围。</li>
<li>根据每行预估的高度，算出一屏显示的 cell 的个数，并先对这些 cell(调用<code>cellForRow...</code>方法)进行绘制。</li>
<li>绘制时拿到 cell 的真实高度,然后放在<code>heightForRow...</code>方法里面拿给 tabelView 去用。</li>
<li>屏幕滚动(有 cell 进入屏幕)的时候,仍然会调用绘制以及获取真实高度的方法。</li>
</ol>
<p>简单点说，预估高度用来让 tableView 心里有个底，把 cell 先绘制出来，但最后实际的 cell 高度还是会从<code>heightForRow...</code>方法中获取。</p>
<p><strong>缺点：</strong></p>
<ol>
<li>设置估算高度后，<code>tableview.contentSize.height</code>根据“cell估算值 x cell个数”计算，这就导致滚动条的大小处于不稳定的状态，contentSize 会随着滚动从估算高度慢慢替换成真实高度，肉眼可见滚动条突然变化甚至“跳跃”。</li>
<li>估算高度使加载速度更快，但侵害滑动流畅性，cell较多情况下滑动时实时计算高度带来的卡顿是明显能体验到的。</li>
</ol>
<h1 id="方案三：self-sizing-cell-（iOS-8-）"><a href="#方案三：self-sizing-cell-（iOS-8-）" class="headerlink" title="方案三：self-sizing cell （iOS 8+）"></a>方案三：self-sizing cell （iOS 8+）</h1><p><strong>设计思路：</strong><br>如图，row123 是已经在屏幕上被展示的cell, 而 row4 是下一个会被展示的cell, 这时 row4 这个 cell 的 rowHeight 是预先为其设置的 estimated height， 又或者是  UITableViewDelegate 中返回的 height。<br>当用户滚动的时候，首先 cell 会被创建或重用，然后 cell 会被调用调整 size 的方法， 接着 cell 会根据 tableView 的size去调整自身的 contentSize，最后cell被展示出来。<br><img src="http://ww2.sinaimg.cn/mw690/005tGCqhjw1f9fwywhi35j308p07zq31.jpg" alt=""><br>如何让一个cell去调整自己的高度？</p>
<ol>
<li>cell 要使用 Autolayout 布局；</li>
<li>在 tableView 中启动动态布局, 告诉 tableView 用新的方法来布局行高.而不是 rowHeight 或者 delegate 方法。<br><code>tableView.rowHeight = UITableViewAutomaticDimension;</code></li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>仅支持iOS 8+；</li>
<li>高度没有缓存。iOS 7 计算高度后有”缓存“机制，不会重复计算；iOS 8 不论何时都会重新计算 cell 高度。</li>
</ol>
<h1 id="方案四：FDTemplateLayoutCell（iOS-6-）"><a href="#方案四：FDTemplateLayoutCell（iOS-6-）" class="headerlink" title="方案四：FDTemplateLayoutCell（iOS 6+）"></a>方案四：FDTemplateLayoutCell（iOS 6+）</h1><p>好处：既有 iOS8 self-sizing 功能简单的 API，又可以达到 iOS7 流畅的滑动效果，还保持了最低支持 iOS6。</p>
<ol>
<li>根据 autolayout 约束自动计算高度。使用了系统在 iOS6 提供的 API：<code>-systemLayoutSizeFittingSize:</code></li>
<li>根据 indexPath 的一套高度缓存机制。<br>计算出的高度会自动进行缓存，所以滑动时每个 cell 真正的高度计算只会发生一次，后面的高度询问都会命中缓存，减少了多余计算。</li>
<li>自动的缓存失效机制。<br>UITableView 刷新时，已有的高度缓存将以最小的代价失效。如删除一个 indexPath 为 [0:5] 的 cell，[0:0] ~ [0:4] 的高度缓存不受影响，而 [0:5] 后面所有的缓存值都向前移动一个位置。自动缓存失效机制对 UITableView 的 9 个公有 API 都进行了分别的处理，以保证没有一次多余的高度计算。</li>
<li>预缓存机制（通过 runloop 实现）。<br>UITableView 没有滑动的空闲时刻会计算和缓存那些还没有显示到屏幕中的 cell，整个缓存过程完全没有感知，这使得完整列表的高度计算既没有发生在加载时，又没有发生在滑动时，同时保证了加载速度和滑动流畅性。</li>
</ol>
<p><strong>缺点：</strong><br>要求约束设置完整准确，保证 contentView 内部上下左右所有方向都有约束支撑，设置不合理的话计算的高度就成了0。（这个实际上是<code>systemLayoutSizeFittingSize:</code>的要求）。</p>
<p>从易用性、性能、高度自适应效果、适配 iOS 最低版本综合来看，方案四是最佳的。但需要引入第三方库，同时要保证 autolayout 约束完整准确才行，关于这点<a href="https://www.jianshu.com/p/386b792054b1" target="_blank" rel="noopener">《UITableViewCell高度自适应的关键点》</a>总结得很好：</p>
<blockquote>
<p>Cell 内部的 Constraints 一定要有一条从 Cell 顶部到底部的一条可联通线。</p>
</blockquote>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://zltunes.github.io/2019/04/12/dynamic-height-cell/" data-id="cjwudq3y00007idrk0asbwwh4" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACHUlEQVR42u3aQZLDIAwEwPz/097rXuKdEclWGZpTynECzUGFJF6veFy/xrvnv7999/z+P+/f/8DAwMB4LOO6HbN37ue6f97Oi4GBcQ4j/+t8idH0QQiOtgMDAwOjDIjtm+32YWBgYLSMNhAnYRoDAwNjlsSuBN9kWbPkGQMD4wRGXnX//89f6W9gYGA8inGVY1Ymmx0li1VhYGBszZj9dd4MWA/ixXowMDA2ZeTpYl4UmzUAZpv1am9nYGBgPJDx7RC5cuEs3ywMDIxzGCuF/pXrp8nz+oSLgYGxHWN9QXlJLpkrPyZiYGCcw2gByeFv5cJZC8bAwNibkR/UZm2DWWOyTp4xMDC2ZsymXDne5U2ClRQXAwNjP8ZKEe0Vj3xrcljdEcXAwHggoz2KfYO6Eo4xMDBOYOSF+zyZbFuY+UKjbcLAwDiAkZfpE2SbxLZhGgMD4xzGrEw/S0rzlLUGY2BgbM3Ig2Yy2UrjMw/xRXaOgYGxBSP/WdvO/NTzqFyIgYFxDGP94sU3vo2COwYGxgGM9SNd3lSoG5OzeiEGBsYWjKsc7RWNPJQnBbU/imsYGBibMmZhLm8htI3P2TUODAyMExizZmSCXA/ExX5jYGAcwEiOeslv2+sas8YnBgYGxnqQzReXpLL1PREMDAyMEpMvKy/AvU1iMTAwtma0F79y9ixxrZNhDAyMrRlt6rjSwmzbCR9uamJgYDyP8QPq9UHPkYRtiQAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/iOS/">iOS</a></div><div class="post-nav"><a class="pre" href="/2019/04/13/reactivecocoa-tutorial/">ReactiveCocoa 入门与登录实战</a><a class="next" href="/2019/04/11/rails-tutorial/">Ruby on Rails 初探</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjkyMi8xMzQ1OA=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://zltunes.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Messages/" style="font-size: 15px;">Messages</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/iPhone/" style="font-size: 15px;">iPhone</a> <a href="/tags/swichphone/" style="font-size: 15px;">换机</a> <a href="/tags/dynamic/" style="font-size: 15px;">动态化</a> <a href="/tags/区块链/" style="font-size: 15px;">区块链</a> <a href="/tags/notification/" style="font-size: 15px;">通知</a> <a href="/tags/JSPatch/" style="font-size: 15px;">JSPatch</a> <a href="/tags/sourcecode/" style="font-size: 15px;">源码</a> <a href="/tags/rails/" style="font-size: 15px;">rails</a> <a href="/tags/ReactiveCocoa/" style="font-size: 15px;">ReactiveCocoa</a> <a href="/tags/ROS/" style="font-size: 15px;">ROS</a> <a href="/tags/robot/" style="font-size: 15px;">机器人</a> <a href="/tags/AVFoundation/" style="font-size: 15px;">AVFoundation</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">zltunes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>