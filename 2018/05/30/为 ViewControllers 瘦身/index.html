<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>为 ViewControllers 瘦身 | zltunes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><link rel="stylesheet" type="text/css" href="/css/code-number.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="/js/code-number.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">为 ViewControllers 瘦身</h1><a id="logo" href="/.">zltunes</a><p class="description">赵磊的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/work/"><i class="fa fa-building"> 作品</i></a><a href="/resume/"><i class="fa fa-file"> 简历</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">为 ViewControllers 瘦身</h1><div class="post-meta">May 30, 2018<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#把TableView从ViewController中抽出来"><span class="toc-number">1.</span> <span class="toc-text">把TableView从ViewController中抽出来</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#把-Data-Source-分离出来"><span class="toc-number">1.1.</span> <span class="toc-text">把 Data Source 分离出来</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#把-Data-Source-和-Delegate-都分离出来"><span class="toc-number">1.2.</span> <span class="toc-text">把 Data Source 和 Delegate 都分离出来</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#抽离TableView终极版"><span class="toc-number">1.3.</span> <span class="toc-text">抽离TableView终极版</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#业务逻辑移到model中"><span class="toc-number">2.</span> <span class="toc-text">业务逻辑移到model中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网络请求逻辑移到model"><span class="toc-number">3.</span> <span class="toc-text">网络请求逻辑移到model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#view代码移到view层"><span class="toc-number">4.</span> <span class="toc-text">view代码移到view层</span></a></li></ol></div></div><div class="post-content"><p>目标：写可维护的代码。<br><a id="more"></a></p>
<h2 id="把TableView从ViewController中抽出来"><a href="#把TableView从ViewController中抽出来" class="headerlink" title="把TableView从ViewController中抽出来"></a>把TableView从ViewController中抽出来</h2><p>UITableView可以说是iOS界面开发中用的最广泛的组件，就我自己做过的项目而言，绝大部份ViewController都是在围绕tableViewDelegate 和 UITableViewDataSource 中的方法打交道。但说到底这些函数都是View层面的，全部在VC中处理显得不太合适，也不利于日后的维护和扩展，所以关于瘦身VC很容易想到一点是从<strong>VC中抽离tableView的表示逻辑</strong>。这种思想其实与最近火热的<a href="http://www.cnblogs.com/ludashi/p/4211556.html" target="_blank" rel="noopener">MVVM</a>设计模式相通。就是<strong>把”逻辑部分”尽量移到Model层</strong>, 你可以认为它是一个中间层 , 所谓”逻辑部分”可以是各种delegate,网络请求,缓存,数据库,coredata等等等等 , 而controller正是用来组织串联他们，使得整个程序走通。</p>
<h3 id="把-Data-Source-分离出来"><a href="#把-Data-Source-分离出来" class="headerlink" title="把 Data Source 分离出来"></a>把 Data Source 分离出来</h3><p>举例:当需要将一个数组映射到一个tableView进行显示，这种一一对应关系可以单独写一个类ArrayDataSource，使用block或者delegate设置cell。ArrayDataSource类完全可以复用到任何需要<strong>将一个数组的内容映射到一个tableView</strong>的场景。<br>ArrayDataSource中声明block(cell,item)来初始化cell，block实现方式（item和cell如何对应）则可以在 cell+Configure 的category中声明。<br>使用ArrayDataSource，在ViewController中执行setUpTableView即可。setUpTableView中实现block（可以是执行configure方法的方式）。使用cell类category的方式是为了<strong>避免向 data source 暴露 cell 的设计</strong>,说白了是为了更好得分离 view 和 model 层。</p>
<blockquote>
<p><a href="https://github.com/objcio/issue-1-lighter-view-controllers" target="_blank" rel="noopener">1.1 参考项目看这里</a></p>
</blockquote>
<h3 id="把-Data-Source-和-Delegate-都分离出来"><a href="#把-Data-Source-和-Delegate-都分离出来" class="headerlink" title="把 Data Source 和 Delegate 都分离出来"></a>把 Data Source 和 Delegate 都分离出来</h3><p>1.1中的方法是在objccn<a href="http://objccn.io/issue-1-1/" target="_blank" rel="noopener">更轻量的ViewControllers</a>一文中提到的。但该文讲的只是把UITableViewDataSource中的方法提取到一个单独的类，从结果来看，是把<code>numberOfRowsInSection</code>和<code>cellForRowAtIndexPath</code>从VC中提取出去。但实际上UITableViewDelegate也是可以抽象出去的。例如cell的生成, cell行高, 点击事件等等。这里我用了block的形式使得函数能够回调。</p>
<p>处理类<code>TableViewDataSourceDelegate.h</code></p>
<pre><code class="objc">#import &lt;Foundation/Foundation.h&gt;
#import &lt;UIKit/UIKit.h&gt;

typedef void    (^TableViewCellConfigureBlock)(NSIndexPath *indexPath, id item, XTRootCustomCell *cell) ;
typedef CGFloat (^CellHeightBlock)(NSIndexPath *indexPath, id item) ;
typedef void    (^DidSelectCellBlock)(NSIndexPath *indexPath, id item) ;

@interface TableViewDataSourceDelegate : NSObject &lt;UITableViewDelegate,UITableViewDataSource&gt;
//初始化方法: 传数据源, cellIdentifier, 三个block分别对应配置, 行高, 点击。
- (id)initWithItems:(NSArray *)anItems
     cellIdentifier:(NSString *)aCellIdentifier
 configureCellBlock:(TableViewCellConfigureBlock)aConfigureCellBlock
    cellHeightBlock:(CellHeightBlock)aHeightBlock
     didSelectBlock:(DidSelectCellBlock)didselectBlock ;

//将UITableViewDataSource和UITableViewDelegate设于TableViewDataSourceDelegate。
- (void)handleTableViewDatasourceAndDelegate:(UITableView *)table ;

//默认indexPath.row对应每个dataSource相应返回item。
- (id)itemAtIndexPath:(NSIndexPath *)indexPath ;

@end
</code></pre>
<p>在1.1中为了避免model和view的耦合，将cell的配置用category方法处理。但使用的方式是每一个UITableViewCell都做了扩展，实际上可以做得更彻底－－－<strong>直接对这些子类的父类UITableViewCell进行扩展</strong>。这样做的好处是比1.1的扩展方法更加灵活，可以提供多个configure方法，针对不同类型的Model进行数据展示，同时也增强Cell的移植性。</p>
<p>对UITableViewCell的扩展<code>UITableViewCell+Extension.h</code></p>
<pre><code class="objc">#import &lt;UIKit/UIKit.h&gt;

@interface UITableViewCell (Extension)

//实际是tableView reigister nib，由于是与cell(view)紧密相关的方法，故在cell本身进行实现，而非在vc中。
+(void) registerTable:(UITableView*)table
        nibIdentifier:(NSString*)identifier;

//根据数据源配置并绘制cell 子类需重写该方法
-(void)configure:(UITableViewCell*)cell
       customObj:(id)obj
       indexPath:(NSIndexPath*)indexPath;

//根据数据源计算cell的高度 子类可重写该方法, 若不写为默认值44.0
+(CGFloat)getCellHeightWithCustomObj:(id)obj
                        indexPath:(NSIndexPath*)indexPath;

@end
</code></pre>
<p>如此，对于每一个Cell子类，实现两个新方法:</p>
<pre><code class="objc">- (void)configure:(UITableViewCell *)cell
        customObj:(id)obj
        indexPath:(NSIndexPath *)indexPath
{
    //Rewrite according to your requirements.
}

+ (CGFloat)getCellHeightWithCustomObj:(id)obj
                            indexPath:(NSIndexPath *)indexPath
{
    //Rewrite according to your requirements.
}
</code></pre>
<p>OK,做了这么多工作，返回VC看一下最后的成果吧！瘦身后的ViewController对于tableView的所有处理都只需要一个方法<code>setUpTableView</code></p>
<pre><code class="objc">- (void)setupTableView
{
    TableViewCellConfigureBlock configureCell = ^(NSIndexPath *indexPath, MyObj *obj, XTRootCustomCell *cell) {
        [cell configure:cell customObj:obj indexPath:indexPath] ;
    } ;

    CellHeightBlock heightBlock = ^CGFloat(NSIndexPath *indexPath, id item) {
        return [MyCell getCellHeightWithCustomObj:item indexPath:indexPath] ;
    } ;

    DidSelectCellBlock selectedBlock = ^(NSIndexPath *indexPath, id item) {
        NSLog(@&quot;click row : %@&quot;,@(indexPath.row)) ;
    } ;

    self.tableHandler = [[TableDataDelegate alloc] initWithItems:self.list
                                                   cellIdentifier:MyCellIdentifier
                                               configureCellBlock:configureCell
                                                  cellHeightBlock:heightBlock
                                                   didSelectBlock:selectedBlock] ;

    [self.tableHander handleTableViewDatasourceAndDelegate:self.table] ;
}
</code></pre>
<blockquote>
<p>1.2 <a href="https://github.com/Akateason/XTTableDatasourceDelegateSeparation" target="_blank" rel="noopener">参考项目看这里</a></p>
</blockquote>
<h3 id="抽离TableView终极版"><a href="#抽离TableView终极版" class="headerlink" title="抽离TableView终极版"></a>抽离TableView终极版</h3><p>经过1.2的处理，UITableViewDelegate 和 UITableViewDataSource 的方法都已经移到<code>TableViewDataSourceDelegate</code>这个类中处理，但根据<br><a href="https://github.com/Akateason/XTTableDatasourceDelegateSeparation" target="_blank" rel="noopener">1.2参考项目</a>可以发现1.2的处理方式有局限性，我们观察<code>TableViewDataSourceDelegate</code>中的核心方法:</p>
<pre><code class="objc">- (id)initWithItems:(NSArray *)anItems
     cellIdentifier:(NSString *)aCellIdentifier
 configureCellBlock:(TableViewCellConfigureBlock)aConfigureCellBlock
    cellHeightBlock:(CellHeightBlock)aHeightBlock
     didSelectBlock:(DidSelectCellBlock)didselectBlock;
</code></pre>
<p><code>TableViewDataSourceDelegate</code>进行初始化时需传递参数<code>CellIdentifier</code>和<code>aHeightBlock</code>,实际开发工作中这两者通常是和<code>UITableViewCell</code>类紧密相关的。一类 UITableViewCell 往往对应一个它自己的 CellIdentifier 和 cellHeight，如果初始化<code>TableViewDataSourceDelegate</code>对象时就指定这两个属性，则<code>TableViewDataSourceDelegate</code>仅局限于被一种tableView复用:cell种类都相同，也就是<strong>用一个tableView展示一个数组</strong>( indexPath.row 对应 数组下标 )。如图：<br><img src="http://ww4.sinaimg.cn/large/005tGCqhjw1ezscp180r2j30af0hz755.jpg" alt=""><br><br><img src="http://ww2.sinaimg.cn/large/005tGCqhjw1ezscrw6qbyj30ah0icgnm.jpg" alt=""></p>
<p>这些cell都是同一种类，但实际开发中往往面临着更复杂的cell样式，如我在开发 <em>校友圈</em> 时：<br><img src="http://ww4.sinaimg.cn/large/005tGCqhjw1ezsd219avzj30ag0ikaau.jpg" alt=""></p>
<p>这种情况怎么使用<code>TableViewDataSourceDelegate</code>呢？<br>我目前是如下方法实现的，但感觉有些太复杂了，如果你有更好的处理方法欢迎与我交流。<br><br><br><strong>a. 修改<code>TableViewDataSourceDelegate</code>的init方法</strong>。</p>
<pre><code class="objc">(id)initWithItems:(NSDictionary *)anItems
configureCellBlock:(TableViewCellConfigureCellBlock)aConfigureCellBlock
   cellHeightBlock:(CellHeightBlock)aHeightBlock
    didSelectBlock:(DidSelectCellBlock)aDidSelectBlock;
</code></pre>
<h2 id="业务逻辑移到model中"><a href="#业务逻辑移到model中" class="headerlink" title="业务逻辑移到model中"></a>业务逻辑移到model中</h2><p>尽管viewController最主要功能是处理业务逻辑，但对于一些和model联系紧密，和view关系不大（即不是model和view进行交互的逻辑）的代码应移到model中，通常是用category的处理方法，更加清晰。</p>
<h2 id="网络请求逻辑移到model"><a href="#网络请求逻辑移到model" class="headerlink" title="网络请求逻辑移到model"></a>网络请求逻辑移到model</h2><p>用category方式处理。viewController使用block回调的方式请求网络。</p>
<h2 id="view代码移到view层"><a href="#view代码移到view层" class="headerlink" title="view代码移到view层"></a>view代码移到view层</h2><p>不要在 view controller 中构建复杂的 view 层次结构。<br>要注意的是， <strong>IB 并非只能和 view controllers 一起使用</strong>，可以加载单独的 nib 文件到自定义的 view 中。</p>
<blockquote>
<p>参考：<a href="http://objccn.io/issue-1-1/" target="_blank" rel="noopener">更轻量的ViewControllers</a></p>
</blockquote>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://zltunes.github.io/2018/05/30/为 ViewControllers 瘦身/" data-id="cji472u1k000i5drkjw4otzo4" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACsElEQVR42u3aQW4jMQwEwPz/01lgTwGyme0mJceHmpMB27JKAUSG5MdH/Hz+fb6+/v48v/v1M9/X/Om7z58/9uDh4eGNtp5sOl8hOaBktfaI/7EyHh4e3jVevqH2gn4+rOfX7XHj4eHhvRvvOYE+mxbnh4KHh4f3zrwkEU/ebQsQL417eHh4eDFvX5zNk+P2yDbFYjw8PLwbvFkD7HdfX+/v4eHh4Y266rNrOk/Wc8Zwb3h4eHgXeM+by0PFqUGEtngRBQw8PDy8a7xNQysZkErWzwNDcfR4eHh4L+Ftttgm1rNhhSJI4OHh4V3m5T/TJuj7oLIq5uLh4eFd5t1IhfflhmHhGA8PD+8or01Y94nv87WevFuEEzw8PLwLvNlFnF/T7ShAm+LXo1d4eHh4h3jJVZ7DZmn0rPVV/w3x8PDw1rz8Kt9URzdF3vbIfhwawMPDwzvE2yfEmwJu2/qaFZfx8PDwbvA2gWEWWqILPUiskyPDw8PDO8vbjEbNrvIc2V73eHh4eK/nJcnuqihwtMoaBQ88PDy8C7wcMGv5n0rKkwLEf9bEw8PDO8RrvzZrYm1GrGZH/zE7FTw8PLzyP/pZySBPx9skeBZy8PDw8F7Dm42W5iMCRVM/3k8RbPDw8PAu8GZNqWE5tQw2+5Xx8PDwXsM7VRueNdiONb3w8PDwrvESxuyH819pW2IHihF4eHh4a17LeC4HJJueFX/rBw8PD+8o77N8krS7DRt52bcePsDDw8O7wJulyKea/TkpL5QMwwkeHh5eyZsNlebXd55wt5+MVsDDw8O7xts0w9rvtuGhDTBR9RcPDw/vl3jtdT8rXszScTw8PLx34LXBoC3CnkrQ8fDw8F7DSy7xduxptt22vLsaIMDDw8M7k6/Wzf6iqLpmz0rAeHh4eId4fwCRkH2CuqWiagAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/iOS/">iOS</a></div><div class="post-nav"><a class="next" href="/2018/05/29/hello-world/">Hello World</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjkyMi8xMzQ1OA=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://zltunes.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/How-To/">How To</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/How-To/Hexo/">Hexo</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/How-To/Hexo/MathJax/">MathJax</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/MathJax/" style="font-size: 15px;">MathJax</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/30/为 ViewControllers 瘦身/">为 ViewControllers 瘦身</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/29/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://dreampiggy.com/" title="小猪的博客" target="_blank">小猪的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">zltunes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>