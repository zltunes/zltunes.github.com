<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Ruby on Rails 初探 | zltunes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><link rel="stylesheet" type="text/css" href="/css/code-number.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="/js/code-number.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Ruby on Rails 初探</h1><a id="logo" href="/.">zltunes</a><p class="description">赵磊的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/work/"><i class="fa fa-building"> 项目</i></a><a href="/resume/resume.pdf"><i class="fa fa-file"> 简历</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Ruby on Rails 初探</h1><div class="post-meta">Jun 15, 2018<span> | </span><span class="category"><a href="/categories/web/">web</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Vagrant-VirtualBox-打造跨平台开发环境"><span class="toc-number">1.</span> <span class="toc-text">Vagrant+VirtualBox 打造跨平台开发环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Rails-Way"><span class="toc-number">2.</span> <span class="toc-text">Rails Way</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#layout-解决代码重复问题"><span class="toc-number">3.</span> <span class="toc-text">layout 解决代码重复问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Asset-Pipeline"><span class="toc-number">4.</span> <span class="toc-text">Asset Pipeline</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Rails-接口操作数据库"><span class="toc-number">5.</span> <span class="toc-text">Rails 接口操作数据库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Partial-实现数据与模版分离"><span class="toc-number">6.</span> <span class="toc-text">Partial 实现数据与模版分离</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CURD"><span class="toc-number">7.</span> <span class="toc-text">CURD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#读取展示"><span class="toc-number">7.1.</span> <span class="toc-text">读取展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#删除资源"><span class="toc-number">7.2.</span> <span class="toc-text">删除资源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Strong-Parameters-防止表单攻击"><span class="toc-number">8.</span> <span class="toc-text">Strong Parameters 防止表单攻击</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rails-的-DRY-don’t-repeat-yourself-原则"><span class="toc-number">9.</span> <span class="toc-text">rails 的 DRY(don’t repeat yourself) 原则</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#资源间建立一对多关系"><span class="toc-number">10.</span> <span class="toc-text">资源间建立一对多关系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#加密及验证"><span class="toc-number">11.</span> <span class="toc-text">加密及验证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#session"><span class="toc-number">12.</span> <span class="toc-text">session</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#记住我"><span class="toc-number">13.</span> <span class="toc-text">记住我</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#表单验证"><span class="toc-number">14.</span> <span class="toc-text">表单验证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#国际化"><span class="toc-number">15.</span> <span class="toc-text">国际化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#优化体验"><span class="toc-number">16.</span> <span class="toc-text">优化体验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#atwho"><span class="toc-number">16.1.</span> <span class="toc-text">atwho</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hot-keys"><span class="toc-number">16.2.</span> <span class="toc-text">hot keys</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#markdown-格式支持"><span class="toc-number">16.3.</span> <span class="toc-text">markdown 格式支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码高亮"><span class="toc-number">16.4.</span> <span class="toc-text">代码高亮</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#权限控制"><span class="toc-number">16.5.</span> <span class="toc-text">权限控制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ActionMailer-实现-mail-服务"><span class="toc-number">17.</span> <span class="toc-text">ActionMailer 实现 mail 服务</span></a></li></ol></div></div><div class="post-content"><p><a href="https://rubyonrails.org" target="_blank" rel="noopener">Ruby on Rails</a> 是一个使用 Ruby 语言写的开源 Web 应用框架，它是严格按照 MVC 结构开发的。目标是努力使自身保持简单，使用最少的配置和代码。后来的 Django(Python)、Laravel(PHP)、 ChicagoBoss(Erlang)等框架都借鉴了 rails 的设计思想。Twitter、GitHub、Groupon，国内的暴走漫画、薄荷网等前期都是用 rails 作为主要的开发框架。虽然现在已经每况日下（ruby小众、性能不佳、社区活跃度低、学习门槛高…），但 rails 仍是一个了不起的框架。本文使用 rails 搭建一个类似 <a href="https://www.meetup.com" target="_blank" rel="noopener">Meetup</a> 的平台，体会 rails 开发的一些基础要素。<br><a id="more"></a></p>
<h1 id="Vagrant-VirtualBox-打造跨平台开发环境"><a href="#Vagrant-VirtualBox-打造跨平台开发环境" class="headerlink" title="Vagrant+VirtualBox 打造跨平台开发环境"></a>Vagrant+VirtualBox 打造跨平台开发环境</h1><p><a href="https://www.vagrantup.com/" target="_blank" rel="noopener">Vagrant</a> + <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="noopener">VirtualBox</a> 应该是目前为止我找到的安装 ubuntu 虚拟机最简单的方式。在 rails 项目中使用 vagrant 搭建开发环境最直观的好处有三个：</p>
<ul>
<li>快。vagrant 重新封包后的 box 很小（远小于 Vmware 克隆出来的虚拟机），因此安装 ubuntu 不到10分钟完成。</li>
<li>共享文件夹。我可以用在 mac 使用 sublime+git 开发，同时在 ubuntu 虚拟机中运行 rails+mysql。二者同步。<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgqo9erpj31j80ssgpf" alt=""></li>
<li>方便协作。与队友合作的时候打包一个已经配置好的 package 直接拿给队友用就可以了。免去了不同机子上折腾环境的问题，极大提高了效率。</li>
</ul>
<blockquote>
<p>这里有一篇<a href="https://github.com/astaxie/Go-in-Action/blob/master/ebook/zh/01.1.md" target="_blank" rel="noopener">详细介绍</a></p>
</blockquote>
<h1 id="Rails-Way"><a href="#Rails-Way" class="headerlink" title="Rails Way"></a>Rails Way</h1><p><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgqyivz0j30oj0dvdgy" alt=""><br>rails 的根本骨架是上面的 MVC 结构。<br>浏览器一个请求进来(这个请求首次是由浏览器输入主页地址敲下 enter 之后，其它是从 view 中的<code>link_path</code>来的，比如按钮点击)，首先由路由代码分发给响应的 controller 来响应该次请求（首次是返回root主页，其它都是在 controller 中定义的 action），controller 选择合适的 html 文件渲染，同时可能有对 model 层的操作，最终响应这次请求。数据放在 model 中，处理后传递给 controller。 具体可见这张图：<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgr4ou5mj31fu164nfh" alt=""><br>如网址首页 root 请求由 page controller 响应，page controller 选择 views 下的同名文件夹之下的 welcome.html (后缀一般是.html.erb )进行渲染。其余请求处理过程都是如此。</p>
<h1 id="layout-解决代码重复问题"><a href="#layout-解决代码重复问题" class="headerlink" title="layout 解决代码重复问题"></a>layout 解决代码重复问题</h1><p>一个项目不同 html 间总有大量重复代码，如 welcome 和 about ，rails 用 layout 解决。打开本项目/layout/application.html.erb可以看到：<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgrcap0jj30s40cc0v3" alt=""><br>具体到需要复用该布局的html只要写<code>yield</code>中的内容即可。</p>
<h1 id="Asset-Pipeline"><a href="#Asset-Pipeline" class="headerlink" title="Asset Pipeline"></a>Asset Pipeline</h1><p>图片和css/js资源在assets下，分别由 application.js 和 application.css 统一管理。<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgrieqkqj30co0d8wfq" alt=""><br>这样在 application.html.erb 中不必再引入所有.css和.js，只要一句<code>&lt;%= stylesheet_link_tag &quot;application&quot; %&gt;</code> 就解决了，代码清爽了很多。多说一句，rails 自带支持 sass ，只要把后缀改为 .css.scss 就可以。</p>
<h1 id="Rails-接口操作数据库"><a href="#Rails-接口操作数据库" class="headerlink" title="Rails 接口操作数据库"></a>Rails 接口操作数据库</h1><p>本项目用 mysql, rails 操作数据库有一套非常简便的接口。<br>创建数据库:</p>
<pre><code class="ruby">rake db:create
</code></pre>
<p>建表： 更改数据库的表结构，rails 给出的方法是<code>migration</code>。</p>
<pre><code class="ruby">rails g migration CreateIssues
</code></pre>
<p>生成的数据库在 db/migrate 下：<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgroxv1xj30ja0cutbj" alt=""><br>数据库建好后就可以创建 model 了。</p>
<h1 id="Partial-实现数据与模版分离"><a href="#Partial-实现数据与模版分离" class="headerlink" title="Partial 实现数据与模版分离"></a>Partial 实现数据与模版分离</h1><p>先补充一点：上面那张 MVC 的图中 controller 和 view 之间那条线是可以传递数据的。这也是 controller 读取 model 层数据交给 view 层进行显示的方式。<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgrubxxgj30yg0ih75q" alt=""><br>主页下边需要显示 issues 列表，包括 issue 的标题、评论数、评论数目等属性。<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgs04lf3j30v00e1whc" alt=""><br>每条 issue 都从 controller 中添加数据和样式显然不合适。rails 的解决方案是<code>partials</code> ，把页面中固定的某个模块抽取出来。如本例中的_issue_list.html.erb 用来管理 issue_list 。具体步骤：先创建数据库并创建对应的 model，请求传来的时候，page_controller 读取数据库内容， partial 定义 model 的显示逻辑，html 用 render 插入 partial ，数据库的内容便呈现给用户了。rails 中的 partials 和 layout 机制都为简化 html 代码，优化架构发挥了很大作用。<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgs5d6frj3142056abn" alt=""></p>
<h1 id="CURD"><a href="#CURD" class="headerlink" title="CURD"></a>CURD</h1><h2 id="读取展示"><a href="#读取展示" class="headerlink" title="读取展示"></a>读取展示</h2><ul>
<li>先在model层为issues添加content，对issues表执行add_column操作。</li>
<li>添加路由， get ‘/issues/:id’ =&gt; “issues#show”</li>
<li>generator 自动创建 controller,同时可以生成对应的 show 模版。controller中定义<code>show action</code>，view 中定义好样式。read 操作完成。</li>
</ul>
<h2 id="删除资源"><a href="#删除资源" class="headerlink" title="删除资源"></a>删除资源</h2><ul>
<li>先从 view 入手，定义删除按钮和链接。</li>
<li>添加路由<code>delete &#39;issues/:id&#39; =&gt; &#39;issues#destroy&#39;</code></li>
<li>controller 中实现<code>destroy</code>方法（对 model 的操作）。</li>
</ul>
<h1 id="Strong-Parameters-防止表单攻击"><a href="#Strong-Parameters-防止表单攻击" class="headerlink" title="Strong Parameters 防止表单攻击"></a>Strong Parameters 防止表单攻击</h1><p>本项目中允许用户发布issue,是通过表单实现的。具体方法是 Issue 的<code>create</code>方法。</p>
<pre><code class="ruby">def create  
  Issue.create(params[:issue])
  redirect_to :root
end
</code></pre>
<p>这样可以向数据库中写入数据，但直接这么提交会报错。</p>
<pre><code class="ruby">ActiveModel::ForbiddenAttributesError
</code></pre>
<p>这个是 rails 为了防止坏人通过表单提交攻击网站，而采用的自我保护机制。如果不加说明坏蛋们就可以在<code>params[:issue]</code> 中人为植入其他的参数，比如<code>admin: true</code>这样就可以给他自己管理员权限了，所以必须要你自己指明哪些字段是允许直接用 params 里的参数来修改的。<br>rails3 创建或更新 Active Record 对象时，Model 中需要列一个白名单，声明哪些属性可以被 parameter 的数据更新。rails4 中用的是 Strong Parameters 的机制，Model 不再负责白名单的维护，把过滤非法属性的职责推给了 Controller。<br>View 层穿过来的数据会转化为一个<code>ActionController::Parameters</code>对象<br>过滤老的<code>ActionController::Parameters</code>对象，生成一个新的。</p>
<ul>
<li>只保留白名单属性</li>
<li>实例变量 @permitted 赋为 true</li>
</ul>
<p>只有 @permitted 为 true 时才可传入 model 层。 具体到本例： 到 issue_controller.rb 中添加：</p>
<pre><code class="ruby">private  
  def issue_params
    params.require(:issue).permit(:title, :content)
  end
</code></pre>
<p>create 方法改为：</p>
<pre><code class="ruby">Issue.create(issue_params)
</code></pre>
<h1 id="rails-的-DRY-don’t-repeat-yourself-原则"><a href="#rails-的-DRY-don’t-repeat-yourself-原则" class="headerlink" title="rails 的 DRY(don’t repeat yourself) 原则"></a>rails 的 DRY(don’t repeat yourself) 原则</h1><p>rails 简化代码有许多优秀的机制。</p>
<ul>
<li>layout 抽取可复用代码。对应<code>&lt;%yield%&gt;</code>。</li>
<li>partials 抽取页面中相对独立的模块。对应<code>render</code>。同样可起到代码复用的作用。</li>
<li>resources 集成 model 的 CURD 操作<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgsg5ztnj30mp0ip420" alt=""></li>
</ul>
<h1 id="资源间建立一对多关系"><a href="#资源间建立一对多关系" class="headerlink" title="资源间建立一对多关系"></a>资源间建立一对多关系</h1><p>前面创建了 issues 表，接着要为每个 issue 添加 comment。 先创建 model：</p>
<pre><code class="ruby">rails g model comment content:text username:string email:string issue_id:integer
</code></pre>
<p>再创建对应的路由和 controller, controller 中定义 comment 的 create 方法。如何在/issues/show.html 中显示所有 comment? 这就涉及到在两个 model 间建立一对多的关系。</p>
<ul>
<li>确保 comments 表里面有<code>issue_id</code>这个字段，注意，<strong>名字一个字都不能错</strong>，因为要用它是和 issues 表产生映射关系的纽带。</li>
<li>到 issue.rb 文件中添加<code>has_many :comments</code></li>
<li>到 comment.rb 中，添加<code>belongs_to :issue</code></li>
</ul>
<p>同理，user 和 comment/issues 各自之间的一对多关系都是这么映射的。<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgsmz306j30k006sgmo" alt=""><br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgt1cvz8j30is05ojse" alt=""><br>这样就可以直接使用<code>issue.comments</code>,<code>comment.issue</code>这样方便的表达。</p>
<pre><code class="ruby">def show  
   @issue = Issue.find(params[:id])
   @comments = @issue.comments
end
</code></pre>
<h1 id="加密及验证"><a href="#加密及验证" class="headerlink" title="加密及验证"></a>加密及验证</h1><p>注册登录是一个网站最基本的用户管理模块。如何把注册表单中提交的明文密码进行加密存储，登录时又如何将用户输入的明文密码与加密后的密码进行匹配？rails 提供一个强大的接口解决 —— <a href="http://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html" target="_blank" rel="noopener">has_secure_password</a>.</p>
<ul>
<li>在 Gemfile 里面添加 Bcrypt。</li>
<li>users 这张表里设置<code>password_digest</code>字段。（表明要存储的是加密后的密码）</li>
<li>User model添加<code>has_secure_password</code>.</li>
<li>controller 定义<code>reate</code>方法：</li>
</ul>
<pre><code class="ruby">def create  
  user = User.new(user_params)
  user.save
  redirect_to :root
end

private  
  def user_params
    params.require(:user).permit!
  end
</code></pre>
<p>注意这里的<code>strong parameter</code>。使用<code>has_secure_password</code>方法后sign up 的行为（数据库创建新用户，密码加密后存储）就都自动完成了。至于登录时的密码匹配工作是由 authenticate 这个方法完成的（后边会看到）。 去数据库看一下：</p>
<pre><code class="ruby">rails c  
u = User.first  
</code></pre>
<p><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgt95ughj30zc04o760" alt=""><br>可以看到密码是加密后的。</p>
<h1 id="session"><a href="#session" class="headerlink" title="session"></a>session</h1><p>session 是 rails 中一个默认就有的方法，可以向里面存放数据，那么只要一直打开网站，那么用户存储的数据就一直存在。<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgtfy8a1j30mg0ca0ux" alt=""><br>规定 session 中存放<code>user_id</code>，怎么显示用户名？rails 中有一个约定俗成的方法<code>current_user</code>:</p>
<pre><code class="ruby">def current_user  
  @current_user ||= User.find(session[:user_id]) if session[:user_id]
end  
helper_method :current_user  
</code></pre>
<p>这样随时可以知道当前是否有用户在线以及在线用户信息。</p>
<h1 id="记住我"><a href="#记住我" class="headerlink" title="记住我"></a>记住我</h1><p>session 存放的数据是临时性的，如果网站关闭了或是关机重启了，session 中的数据也就丢失了。实现<code>remember me</code>需要 cookie 。cookie 可以把服务器发过来的数据保留成一个<strong>本地硬盘</strong>上的一个文件。另外，rails 同样提供了一个方法叫<code>cookies</code> 可以方便开发者操作 cookie。<br>实现remember的关键代码：</p>
<pre><code class="ruby">cookies.permanent[:auth_token] = user.auth_token  
</code></pre>
<p>如果用户不打算 remember me:</p>
<pre><code class="ruby">cookies[:auth_token] = user.auth_token
</code></pre>
<p>这种效果跟 session 是一样的。<br>用户在 cookie 中怎么存储？<br>cookie 中的数据是要存到本地的，显然不能直接把用户id存起来。所以通过为每一个用户生成一串随机数，用来代表他的身份。数据库中为每个 User 添加<code>auth token</code>字段（base 64存储）：</p>
<pre><code class="ruby">rails g migration AddAuthTokenToUsers auth_token:string  
</code></pre>
<p>生成<code>auth_token</code>方法：</p>
<pre><code class="ruby">before_create { generate_token(:auth_token) }

def generate_token(column)  
  begin
    self[column] = SecureRandom.urlsafe_base64
  end while User.exists?(column =&gt; self[column])
end  
</code></pre>
<h1 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h1><p>rails 自带的<code>validator</code>接口基本满足最常用的情况。user model中：</p>
<pre><code class="ruby">validates :name, :email, presence: true  
validates :name, :email, uniqueness: { case_sensitive: false }  
</code></pre>
<p><code>presence: true</code>表明 name/email 都是必填项。<code>uniqueness</code>保证唯一性。<code>validator</code> 接口方法的触发时机是在向数据库中 save 之前。因此之前 user 的 create 方法中保存 cookie 前要加判断条件<code>if user.save</code> 。save 成功说明已经通过 validator 的验证。</p>
<h1 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h1><p>rails中使用<code>i18N</code>实现国际化。<br>application.rb 设置语言类型： </p>
<pre><code class="ruby">config.i18n.default_locale = &#39;zh-CN&#39;
</code></pre>
<p>书写 zh-CN.yml, 将需要翻译的词进行翻译。</p>
<h1 id="优化体验"><a href="#优化体验" class="headerlink" title="优化体验"></a>优化体验</h1><h2 id="atwho"><a href="#atwho" class="headerlink" title="atwho"></a>atwho</h2><p>用到<a href="https://github.com/ichord/jquery-atwho-rails" target="_blank" rel="noopener">jquery-atwho-rails gem</a>, comment_box 添加<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgpvuzw9j314s0eawhr" alt=""><br>基本原理就是定义一个数组，拿到页面上的所有用户名，检查有无重复。</p>
<h2 id="hot-keys"><a href="#hot-keys" class="headerlink" title="hot keys"></a>hot keys</h2><p>用到<a href="https://github.com/jeresig/jquery.hotkeys" target="_blank" rel="noopener">jquery.hotkeys</a>, comment_box 添加<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgtpfnkpj314o0aw76k" alt=""><br><code>13</code>对应回车键，<code>ctrKey</code>对应 ctrl，<code>metaKey</code>在 Mac 下对应 Command 键， Windows 下应该对应 Window 键。</p>
<h2 id="markdown-格式支持"><a href="#markdown-格式支持" class="headerlink" title="markdown 格式支持"></a>markdown 格式支持</h2><p>用到<a href="https://github.com/vmg/redcarpet" target="_blank" rel="noopener">redcarpet</a>, application_helper.rb 中：<br><img src="https://ww1.sinaimg.cn/large/005YhI8igy1fwrgu5dmk1j31380hsq6a" alt=""><br><code>html_safe :</code>如果去掉，页面中刷新会出现 html 标签，这是一种<strong>安全机制</strong>，防止有人嵌入 html 代码来实现对网站的攻击。不过前面<code>filter_html: true</code>已经过滤掉了可能导致安全隐患的 html 标签。所以就可以放心的来添加 <code>.html_safe</code>来让 rails 放弃这种安全机制了。</p>
<h2 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h2><p>用到<a href="https://github.com/tmm1/pygments.rb" target="_blank" rel="noopener">pygemnt</a></p>
<h2 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h2><p>这里涉及到的只是非常简单的权限控制，包括只有登录用户<code>(@current_user)</code>能发布 issue，只有 issue 的作者本人可以删除或编辑<br>issue: </p>
<pre><code class="ruby">&lt;% if current_user &amp;&amp; current_user == @issue.user %&gt; 
</code></pre>
<p>可以看出主要是通过<code>current_user</code>实现的，同时要设置好 user 和 issue 的一对多关系。</p>
<h1 id="ActionMailer-实现-mail-服务"><a href="#ActionMailer-实现-mail-服务" class="headerlink" title="ActionMailer 实现 mail 服务"></a>ActionMailer 实现 mail 服务</h1><p>ActionMailer 用户注册后发送欢迎邮件。 代码写在<code>user.save</code>之后： </p>
<pre><code class="ruby">UserMailer.welcome_email(@user).deliver
</code></pre>
<p>生成 UserMailer 和 welcome email 方法。再修改 user mailer.rb，就跟 controller action 差不多，再写一个 view 文件－－邮件正文。实现发邮件功能需要集成第三方服务<a href="https://www.mailgun.com" target="_blank" rel="noopener">Mailgun</a>或国内的<a href="https://www.sendcloud.net" target="_blank" rel="noopener">sendCloud</a>。</p>
<blockquote>
<p><a href="https://github.com/zltunes/Meetup" target="_blank" rel="noopener">源码</a></p>
</blockquote>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://zltunes.github.io/2018/06/15/rails-tutorial/" data-id="cjswlqxlo0012p2rkqsb7othb" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACHElEQVR42u3aS27DMAwFwNz/0u62mziPZNxC0mhVII6sSQFC/Lxe8brerN+fvns+2bn6rebCwMBYlnHdrncvuGfcvyXB5GfDwMA4h5FvfX+4JBDn1ORsGBgYGFVS786GgYGB8XTAzZPS5IKIgYGBMUlik8Mll79/zsUxMDAWZORV97//+5H+BgYGxlKMq7jy4NhrZPYWBgbG3oxeAzJvbc6DeKEhioGBsTXjvnCWJ6XzhPO+YRC1QjEwMI5k5AW1PBzf/2S9kh8GBsbejN6g6ncP12t2RrEfAwNjccakxFY9Yi80R6kvBgbGAYw8Na0+02uClnkYGBhbM5IgmBf386vepDAX/WcwMDA2YuTls/yVeRqcNyE+BGIMDIwDGL3tkstitc3QBGNgYGzNqA5v9doA83yzfGgMDIxNGdVNeyW2eaiNZkYwMDA2YlSL9ZNUtnrhKwRrDAyMYxjzRHE+HNbbDQMDY2/G5GWFsa04Pe4V5jAwME5g5IE1v0r2vtW7IGJgYJzGqI6Q5p9WL4U5GwMD4zRG3rz8bsNyHvQxMDB2ZVzFlfdFe23OR/JvDAyMxRnzon811UzmPppXQwwMjK0ZT6SavYGwarAedTYwMDAWZFSbkdVCW/7d3mkxMDAw8oDbi4f5WNgjARcDA2NrRn64+dDqhycxMDAOYCSpZrXZmSSx1X0wMDDOZPRGHKrjYt8K1qOmJgYGxnqMH9X2vCqv8qZDAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/rails/">rails</a><a href="/tags/web/">web</a></div><div class="post-nav"><a class="pre" href="/2019/02/02/dynamiccard/">DynamicCard - 基于 FlexBoxLayout 的动态排版渲染引擎</a><a class="next" href="/2018/06/14/reactivecocoa-tutorial/">ReactiveCocoa 入门与登录实战</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjkyMi8xMzQ1OA=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://zltunes.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/JSPatch/" style="font-size: 15px;">JSPatch</a> <a href="/tags/区块链/" style="font-size: 15px;">区块链</a> <a href="/tags/iPhone/" style="font-size: 15px;">iPhone</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/swichphone/" style="font-size: 15px;">换机</a> <a href="/tags/Messages/" style="font-size: 15px;">Messages</a> <a href="/tags/notification/" style="font-size: 15px;">通知</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/sourcecode/" style="font-size: 15px;">源码</a> <a href="/tags/dynamic/" style="font-size: 15px;">动态化</a> <a href="/tags/rails/" style="font-size: 15px;">rails</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/ROS/" style="font-size: 15px;">ROS</a> <a href="/tags/robot/" style="font-size: 15px;">机器人</a> <a href="/tags/ReactiveCocoa/" style="font-size: 15px;">ReactiveCocoa</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">zltunes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>